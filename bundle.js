(()=>{"use strict";window.utils={getRandomNumber:function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e},getRandomElement:function(e){return e[Math.floor(Math.random()*e.length)]},isEscButton:e=>"Escape"===e,isEnterButton:e=>"Enter"===e,getShuffleElements:e=>{for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e},debounceDecorator:e=>{let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},getDeclension:(e,t)=>t[e%100>4&&e%100<20?2:[2,0,1,1,1,2][e%10<5?e%10:5]]},(()=>{const e=document.querySelector("main"),t=document.querySelector("#pictures-error").content.querySelector(".pictures-error"),n=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success"),r=(t,n)=>{const o=e.appendChild(t),r=()=>{e.removeChild(o),document.removeEventListener("keydown",i)},i=e=>{window.utils.isEscButton(e.key)&&r()};o.querySelector(`.${n}__button`).addEventListener("click",r),document.addEventListener("keydown",i),o.addEventListener("click",(e=>{e.target.closest(`.${n}__inner`)||r()}))};window.modal={loadError:n=>{const o=t.cloneNode(!0);o.querySelector(".pictures-error__title").textContent=n;const r=e.appendChild(o);setTimeout((()=>{e.removeChild(r)}),5e3)},uploadError:()=>{const e=n.cloneNode(!0);r(e,"error")},uploadSuccess:()=>{const e=o.cloneNode(!0);r(e,"success")}}})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram/data",t="https://21.javascript.pages.academy/kekstagram",n={400:"Bad Request (400).",401:"Unauthorized (401).",402:"Payment Required (402).",403:"Forbidden (403).",404:"Not Found (404).",405:"Method Not Allowed (405).",406:"Not Acceptable (406).",407:"Proxy Authentication Required (407).",408:"Request Timeout (408).",409:"Conflict (409).",410:"Gone (410).",411:"Length Required (411).",412:"Precondition Failed (412).",413:"Request Entity Too Large (413).",414:"Request-URI Too Long (414).",415:"Unsupported Media Type (415).",416:"Requested Range Not Satisfiable (416).",417:"Expectation Failed (417)."},o=(e,t)=>{const o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(()=>{let r;switch(o.status.toString()[0]){case"2":e(o.response);break;case"4":r=n[o.status];break;default:r=`${o.statusText} (${o.status}).`}r&&t(r)})),o.addEventListener("error",(()=>{t("Ошибка соединения (001).")})),o.addEventListener("timeout",(()=>{t("Превышено время ожидания ответа от сервера (002).")})),o.timeout=1e5,o};window.backend={load:(t,n)=>{const r=o(t,n);r.open("GET",e),r.send()},upload:(e,n,r)=>{const i=o(n,r);i.open("POST",t),i.send(e)}}})(),(()=>{const e=document.querySelector(".social__comment-count"),t=document.querySelector(".comments-loader"),n=document.querySelector(".social__comments"),o=document.querySelector(".social__comment").cloneNode(!0);let r;class i{constructor(e){this._arr=e,this._length=e.length,this._startCount=0,this._endCount=0,this._stringName=window.utils.getDeclension(this._length,["комментария","комментариев","комментариев"]),this.isMax=!1}get currentString(){return this.isMax?null:`${this._endCount} из <span class="comments-count">${this._length}</span> ${this._stringName}`}get currentSlice(){return this.isMax?null:this._arr.slice(this._startCount,this._endCount)}isLastStep(){return this._endCount===this._length}increaseCount(){if(!this.isMax){const e=this._endCount+5>this._length?this._length:this._endCount+5;this._startCount=this._endCount,this._endCount=e,this.isMax=this._startCount===this._length}return this.isMax}}const s=()=>{if(!r.increaseCount()){e.innerHTML=r.currentString;const i=(e=>{const t=document.createDocumentFragment();return e.forEach((e=>{const n=o.cloneNode(!0);n.querySelector(".social__picture").src=e.avatar,n.querySelector(".social__picture").alt=e.name,n.querySelector(".social__text").textContent=e.message,t.appendChild(n)})),t})(r.currentSlice);n.appendChild(i),r.isLastStep()&&t.classList.add("hidden")}};t.addEventListener("click",s),window.comments={set:e=>{r=new i(e),t.classList.remove("hidden"),n.textContent="",s()}}})(),(()=>{const e=document.querySelector(".big-picture"),t=document.querySelector(".big-picture__cancel"),n=function(e){window.utils.isEscButton(e.key)&&o()},o=function(){document.body.classList.remove("modal-open"),e.classList.add("hidden"),document.removeEventListener("keydown",n)};t.addEventListener("click",o),window.picture={render:function(t){e.querySelector(".big-picture__img").querySelector("img").src=t.url,e.querySelector(".likes-count").textContent=t.likes,e.querySelector(".comments-count").textContent=t.comments.length,e.querySelector(".social__caption").textContent=t.description,window.comments.set(t.comments)},open:function(){document.body.classList.add("modal-open"),e.classList.remove("hidden"),document.addEventListener("keydown",n)},close:o,init:function(){e.querySelector(".social__comment-count").classList.add("hidden"),e.querySelector(".comments-loader").classList.add("hidden")}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content.querySelector(".picture"),n=document.querySelector(".img-filters");e.addEventListener("click",(t=>{const n=t.target.closest(".picture");if(n){const t=function(t){const n=e.querySelectorAll(".picture");return Array.from(n).indexOf(t)}(n);window.picture.render(window.pictures[t]),window.picture.open()}}));const o=n=>{window.pictures=n;const o=function(e){const n=document.createDocumentFragment();return e.forEach((e=>{const o=t.cloneNode(!0);o.querySelector(".picture__img").src=e.url,o.querySelector(".picture__likes").textContent=e.likes,o.querySelector(".picture__comments").textContent=e.comments.length,n.appendChild(o)})),n}(n);(()=>{const t=document.querySelectorAll(".picture");for(const n of t)e.removeChild(n)})(),e.appendChild(o)};window.gallery={init:e=>{o(e),window.galleryFiltration=window.pictures.slice(),n.classList.remove("img-filters--inactive")},render:o}})(),(()=>{const e=document.querySelector(".img-filters__form"),t={default(){return this.getDefaultArr()},random(){return window.utils.getShuffleElements(this.getDefaultArr()).slice(0,10)},discussed(){return this.getDefaultArr().sort(((e,t)=>t.comments.length===e.comments.length?t.likes-e.likes:t.comments.length-e.comments.length))},getDefaultArr:()=>window.galleryFiltration},n=window.utils.debounceDecorator(((e,n)=>{document.querySelector(".img-filters__button--active").classList.remove("img-filters__button--active"),window.pictures=t[n](),window.gallery.render(window.pictures),e.classList.add("img-filters__button--active")}));e.addEventListener("click",(e=>{if(e.target.classList.contains("img-filters__button")){const t=e.target.id.replace("filter-","");n(e.target,t)}}))})(),(()=>{const e=document.querySelector(".img-upload__effect-level"),t=e.querySelector(".effect-level__line"),n=e.querySelector(".effect-level__value"),o=e.querySelector(".effect-level__pin"),r=e.querySelector(".effect-level__depth"),i=()=>{const e=e=>{let i=(o.offsetLeft+e.movementX)/t.offsetWidth*100;i>100?i=100:i<0&&(i=0),o.style.left=i+"%",r.style.width=i+"%",n.value=Math.floor(i),window.effects.change(Math.floor(i))},i=()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",e),document.addEventListener("mouseup",i)};o.addEventListener("mousedown",i),window.slider={node:e,value:n,pin:o,handler:i,setValue:function(e=0){o.style.left=e+"%",r.style.width=e+"%",n.value=e}}})(),(()=>{const e=document.querySelector("#upload-select-image"),t=e.querySelector("#upload-file"),n=e.querySelector("#upload-cancel"),o=e.querySelector(".img-upload__overlay"),r=e.querySelector(".img-upload__preview img"),i=e.querySelector(".text__hashtags"),s=e.querySelector(".text__description"),c=document.querySelector(".img-upload__form"),l=function(e){window.utils.isEscButton(e.key)&&document.activeElement!==i&&document.activeElement!==s&&(window.validation.textHashtagInput.value="",a())},a=function(){t.value="",document.body.classList.remove("modal-open"),o.classList.add("hidden"),window.slider.setValue(),r.removeAttribute("style"),i.removeEventListener("input",window.validation.textHashtag),e.removeEventListener("submit",window.validation.formSubmit),document.removeEventListener("keydown",l)};t.addEventListener("change",(()=>{document.body.classList.add("modal-open"),o.classList.remove("hidden")})),t.addEventListener("change",(()=>{const n=t.files[0],s=new FileReader;s.onloadend=()=>{r.src=s.result,document.body.classList.add("modal-open"),o.classList.remove("hidden"),window.slider.node.classList.add("hidden"),window.setScaleValue(),i.addEventListener("input",window.validation.textHashtag),e.addEventListener("submit",window.validation.formSubmit),document.addEventListener("keydown",l)},n&&s.readAsDataURL(n)})),n.addEventListener("click",a),window.preview={close:a,form:c,img:r,hashtagsInput:i,descriptionTextarea:s}})(),(()=>{const e=document.querySelector(".effects__list"),t={chrome:{filter:"grayscale",min:0,max:1,measure:""},sepia:{filter:"sepia",min:0,max:1,measure:""},marvin:{filter:"invert",min:0,max:100,measure:"%"},phobos:{filter:"blur",min:0,max:3,measure:"px"},heat:{filter:"brightness",min:1,max:3,measure:""}};let n="none";const o=function(e){if("none"!==n){const o=t[n],r=(o.max-o.min)/100*e+o.min,i=`${o.filter}(${r}${o.measure})`;window.preview.img.style.filter=i}};e.addEventListener("click",(e=>{const t=e.target.classList.contains("effects__radio")?e.target.value:null;t&&function(e="none"){n=e,window.preview.img.style.removeProperty("filter"),window.slider.setValue(100),o(100);const t="none"!==e?"remove":"add";window.slider.node.classList[t]("hidden")}(t)})),window.effects={change:o}})(),(()=>{const e=document.querySelector(".img-upload__scale"),t=e.querySelector(".scale__control--smaller"),n=e.querySelector(".scale__control--bigger"),o=e.querySelector(".scale__control--value"),r=function(e=100){e-25<25?(o.value="25%",window.preview.img.style.transform="scale(0.25)"):e+25>100?(o.value="100%",window.preview.img.style.transform="scale(1)"):(o.value=e+"%",window.preview.img.style.transform=`scale(${e/100})`)};t.addEventListener("click",(function(){const e=o.value;r(parseInt(e,10)-25)})),n.addEventListener("click",(function(){const e=o.value;r(parseInt(e,10)+25)})),window.setScaleValue=r})(),(()=>{const e=document.querySelector("#upload-select-image").querySelector(".text__hashtags");window.validation={textHashtagInput:e,textHashtag:()=>{(()=>{const t=e.value.trim(),n=t.split(" ").filter((e=>e.length)),o=(e=>e.every((e=>e.startsWith("#"))))(n)&&(e=>{const t=RegExp("^(#[а-яА-ЯёЁa-zA-Z0-9]+,? *)*#[а-яА-ЯёЁa-zA-Z0-9]{4,19$");return e.every((e=>t.test(e)))})(n)&&(e=>e.length===new Set(e.map((e=>e.toUpperCase()))).size)(n)&&(e=>e.length<=5)(n);return!t.length||o})()?e.setCustomValidity(""):e.setCustomValidity("Хэш-тег не прошёл валидацию")},formSubmit:t=>{e.validity.valid||t.preventDefault()}}})(),document.querySelector(".img-upload__submit").addEventListener("click",(e=>{if(window.preview.form.checkValidity()){e.preventDefault();const t=new FormData(window.preview.form);window.preview.close(),window.backend.upload(t,window.modal.uploadSuccess,window.modal.uploadError)}else window.preview.hashtagsInput.classList.add("invalid-input"),setTimeout((()=>{window.preview.hashtagsInput.classList.remove("invalid-input")}),5e3)})),window.backend.load(window.gallery.init,window.modal.loadError),window.slider.setValue()})();